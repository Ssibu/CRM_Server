import NewsAndEvent from '../models/newsAndEvent.model.js';
import fs from 'fs';
import path from 'path';

// Create a new News & Event
export const create = async (req, res) => {
  try {
    const { titleEnglish, titleOdia, eventDate, descriptionEnglish, descriptionOdia } = req.body;
    
    if (!req.file) {
      return res.status(400).send({ message: "A document or image file is required." });
    }
    
    const newEvent = await NewsAndEvent.create({
      titleEnglish,
      titleOdia,
      eventDate,
      descriptionEnglish,
      descriptionOdia,
      document: req.file.filename // Save the unique filename generated by multer
    });
    res.status(201).send(newEvent);
  } catch (error) {
    res.status(500).send({ message: error.message || "Error creating News & Event." });
  }
};

// Retrieve all News & Events
export const findAll = async (req, res) => {
  try {
    const events = await NewsAndEvent.findAll({ order: [['displayOrder', 'ASC']] });
    res.status(200).send(events);
  } catch (error) {
    res.status(500).send({ message: error.message || "Error retrieving News & Events." });
  }
};

// Delete a News & Event by ID
export const destroy = async (req, res) => {
  const { id } = req.params;
  try {
    const event = await NewsAndEvent.findByPk(id);
    if (!event) {
      return res.status(404).send({ message: `Event not found.` });
    }

    // Also delete the associated file from the server
    if (event.document) {
      const filePath = path.join('public/uploads/', event.document);
      if (fs.existsSync(filePath)) {
        fs.unlinkSync(filePath);
      }
    }

    await NewsAndEvent.destroy({ where: { id: id } });
    res.status(200).send({ message: "Event was deleted successfully!" });
  } catch (error) {
    res.status(500).send({ message: `Could not delete event.` });
  }
};

// NOTE: You would add 'update' and 'updateOrder' functions here as needed,
// following the patterns from your other controllers.